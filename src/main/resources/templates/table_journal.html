<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title>Журнал</title>
    <link rel="stylesheet" href="/css/style_header.css">
    <link  type="text/css" rel="stylesheet" th:href="@{/css/style_teacher.css}"/>
    <link  type="text/css" rel="stylesheet" th:href="@{/css/style_table.css}"/>
    <script
            src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>

    <script type="text/javascript" src="//cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>


    <style>

    .menu ul li:nth-child(4){
    border-bottom: 1px solid rgb(26, 122, 201);
  }
  table{
   border-collapse: collapse;

   border: 1px solid grey;
  }
    </style>
</head>
<body>
<div th:replace="fragments/header :: header"/>
<main>
    <form th:method="POST" th:action="@{/teacher/{id}/journal/add (id=${constructor.getId()})}">
        <input type="text" placeholder="Номер группы" name="numGroup">
        <button class="btn" type="submit">Добавить в журнал</button>
    </form>
    <form th:method="POST" th:action="@{/teacher/{id}/journal/delete (id=${constructor.getId()})}">
        <input type="text" placeholder="Номер группы" name="numGroup">
        <button class="btn" type="submit">Удалить из журнала</button>
    </form>



    <table th:if="${progress != null}" id="table_progress" >
        <caption th:text="${constructor.getSubject()}"></caption>
        <tr>
            <th>№ Группы</th>
            <th>ФИО</th>
            <th th:if="${progress.get(0).getLab().length != 0}"
                th:each="i : ${#numbers.sequence(1, progress.get(0).getLab().length)}"
                th:text="'Лаб-' + ${i}"></th>
            <th th:if="${progress.get(0).getTest().length != 0}"
                th:each="i : ${#numbers.sequence(1, progress.get(0).getTest().length)}"
                th:text="'Тест-' + ${i}"></th>
            <th th:if="${progress.get(0).getCoursework().length != 0}"
                th:each="i : ${#numbers.sequence(1, progress.get(0).getCoursework().length)}"
                th:text="'Курсач-' + ${i}"></th>


        </tr>
        <tr th:each="prog : ${progress}">
            <td th:text="${prog.getId()}" hidden>id</td>
            <td th:text="${prog.getNgroup()}">№ группы</td>
            <td th:text="${prog.getFullname()}"></td>
            <td contenteditable="true" th:if="${prog.getLab().length != 0}"
                th:each="i : ${#numbers.sequence(1, prog.getLab().length)}"
                th:text="${prog.getLab()[i-1]}">0</td>
            <td contenteditable="true" th:if="${prog.getTest().length != 0}"
                th:each="i : ${#numbers.sequence(1, prog.getTest().length)}"
                th:text="${prog.getTest[i-1]}">0</td>
            <td contenteditable="true" th:if="${prog.getCoursework().length != 0}"
                th:each="i : ${#numbers.sequence(1, prog.getCoursework().length)}"
                th:text="${prog.getCoursework()[i-1]}">0</td>
              <td><a href="#" class="updateP">Save</a></td>
        </tr>

    </table>



</main>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>

    $(document).ready(function () {
     var countlab=0;
     var counttest=0;
     var countcoursework=0;
     var buf;
   $('table tr').each(function(row){
	$(this).find('th').each(function(cell){
      if(cell>1){
      buf=$(this).html();
      switch(buf[0]){
      case "Л":countlab++; break;
      case "Т":counttest++; break;
      case "К":countcoursework++; break;
      }
      }
		//console.log('Количество лаборторных ' + countlab +' Количество тестов '+ counttest + 'курсовых - '+ countcoursework );
	});
});











    $(".updateP").click(function (event) {

        //stop submit the form, we will post it manually.
        event.preventDefault();
        var search = {};
        var mas=[];
     var row = $(this).closest("tr");
  var numRow = row.parent().children("tr").index(row);

  $('table tr').each(function(row){
	$(this).find('td').each(function(cell){
	if(row==numRow){
     if(cell==0){ search["id"] = $(this).html(); }
     if(cell>2){
      mas.push(parseInt($(this).html()));
     }
		console.log('Строка ' + row + ', ячейка ' + cell + ', значение: ' + $(this).html());
	}});
});

   mas.pop();
  console.log(mas);
  search["countlab"]=countlab;
  search["counttest"]=counttest;
  search["countcoursework"]=countcoursework;
  search["result"]=mas;



    //search["email"] = 10;

    $("#btn-search").prop("disabled", true);

    $.ajax({
        type: "POST",
        contentType: "application/json",
        url: "/test",
        data: JSON.stringify(search),
        dataType: 'json',
        cache: false,
        timeout: 600000,
        success: function (data) {

            console.log("SUCCESS : ", data);

        }

    });

    });

});


</script>

</body>
</html>